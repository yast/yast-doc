<HTML>
<HEAD>
<TITLE>YaST2 automatic testing</TITLE>
</HEAD>
<BODY bgcolor=#ffffff>
<P><IMG SRC="../../images/heading.png"></IMG></P>
<H1>DISCLAIMER</H1>
<bigger>This document contains the description of
a sample setup. It doesn't need to be exhaustive nor
correct. If you find an error or otherwise know better,
let the author know.</bigger><BR>
<P>
<HR>
<H1>YaST2 automatic testing</H1>
Every YaST2 module (C++ source and YCP source) must come with
a testsuite for regression testing.<BR>
<P>
<H2>Introduction</H2>
The testsuite basically contains one or more tests for every
feature (function) of a given module. All these tests must be
run every time a change (bugfix) was made. It is especially
important to run <b>all</b> tests for <b>all</b> functions, even
though the bugfix affected only a single function. This is
called <b>regression testing</b>.<BR>
<P>

Testing is done with 
<A HREF="http://www.gnu.org/software/dejagnu/dejagnu.html">dejagnu</A> software
from the <A HREF=""http://www.gnu.org">GNU project.</A><BR>
On SuSE systems you can find the dejagnu package in the 'tcl' series.<BR>
<P>
This testing environment supports protable testing, and
can easily be adapted by use of the 
<A HREF="http://expect.nist.gov">expect</A> tool.<BR>
<p>
<H2>Prerequisites</H2>
Source maintainers are requested to<br>
- provide tests for every feature they design<br>
- update tests for every change they make<br>
- perform a full test before checking in changes<br>
<p>
Besides providing the test data (input and expected output), the
enviroment to perform the tests (i.e. start of daemons) must be
documented. Dejagnu supports all this.<BR>
<p>
<H2>Setting up directories and files</H2>
<H3>testsuite</H3>
All data and files for the testsuite must be located in the
toplevel directory <tt>testsuite</tt>. At least, this is where
autoconf/automake looks for when you run <tt>make check</tt>.<BR>
<P>
The <tt>Makefile.am</tt> inside the <TT>testsuite</TT> directory
must have
<PRE>
AUTOMAKE_OPTIONS = dejagnu
</PRE>
set, so automake recognizes this directory as a dejagnu testsuite.<BR>
<P>
In dejagnu-'speak', the testsuite tests a <i>tool</i>. The name of the
tool is used in setting up the test environment and running the tests.<BR>
Since we set <TT>AUTOMAKE_OPTIONS</TT>, the tool name is the program name
used in the call to <TT>AM_INIT_AUTOMAKE()</TT> in <TT>configure.in</TT>.<BR>
For YaST2 packages, the tool-name is the same as the package name
defined in the file <TT>RPMNAME</TT>.<BR>
<P>
<H3>Directory <tt><b>testsuite/config</b></tt></H3>

Below <tt>testsuite</tt> create a directory named <tt>config</tt> with the
following three files: <TT>default.exp</TT>, <TT>unix.exp</TT>, and
<TT>unknown.exp</TT>. These files are used by <TT>expect</TT>, hence the
extension <TT>.exp</TT>.<BR><P>
The file in config are used to configure the testsuite for different
target systems. Since we're only talking linux -- which is mostly
unix compatible (:-)) -- <tt>unix.exp</tt> is interesting for us.<BR>
<tt>default.exp</tt> should remain empty, <tt>unknown.exp</tt> should
contain the following two lines
<PRE>
perror "No setup for current configuration"
exit 1
</PRE>
<BR>
These configuration files are used to set up different testing
environments on different machine/OS combination. One could even
do cross-platform testing. More about this is in the dejagnu
documentation.
<BR>
<p>
<H3>File <tt><b>testsuite/config/unix.exp</b></tt></H3>
This file, the 'tool-and-target-specific interface file',
 contains the setup procedures for the tool in a unix environment.<BR>
There are three functions to be defined<BR>
<UL>
<LI><i>tool</i>_start</LI>
<LI><i>tool</i>_exit</LI>
<LI><i>tool</i>_version</LI>
</UL>
where <i>tool</i> should be replaced by the tool being tested.<BR>
Remember that these functions are to be written in expect syntax which
is basically Tcl/Tk.<BR>
<P>
The <TT><i>tool</i>_start</TT> function can be used to setup the
testing environment, usually this means starting a deamon or - for interactive tools -
the tool itself.<BR> If you don't need any special setup, just don't
define <TT><i>tool</i>_start</TT> at all.<BR>
If you define a start-function, you must also call this function inside
<TT>unix.exp</TT>, dejagnu just executes this file.<BR>
<P>
The <TT><i>tool</i>_exit</TT> function is called at the end of the
test cycle and unsually is the counterpart to <TT><i>tool</i>_start</TT>.<BR>
<P>
If you didn't define <TT><i>tool</i>_start</TT>, leave <TT><i>tool</i>_exit</TT>
empty:<BR>
<PRE>
tool_exit {} {}
</PRE>
<smaller>This is tcl/tk syntax !</smaller><BR>
<P>
The <TT><i>tool</i>_version</TT> function is used to pass version information
to the testsuite. It should be defined but can be left empty, just like
the <TT><i>tool</i>_exit</TT> function:<BR>
<PRE>
tool_version {} {}
</PRE>
<BR>
<P>
<H3>Directory <tt><b>testsuite/<i>tool</i>.test</b></tt></H3>
Dejagnu executes every <TT>*.exp</tt> file it finds in this
directory. Normally, you put a single <i>tool</i>.exp file here
which runs all tests. However, if you want different setup, you
might also create one file for each setup.<BR>
<P>
For testing the YCP interpreter, all test data is put in a
directory <tt>tests</tt> and the <tt>libycp.exp</tt> file
reads as follows:
<PRE>
# 'main' file for all ycp tests
#
 
# get all files matching tests/*.ycp
  
set filenames [glob $srcdir/tests/*.ycp]
   
# foreach file, call ycp-run (from testsuite/lib)
    
foreach file $filenames { ycp-run $file }
</PRE>

So this is pretty straight-forward (I hope ...)<BR>
<BR>
The <tt>ycp-run</tt> function called will be described below,
this is were the test results are defined.<BR>
Each test can return one of three possible values by calling
the appropriate function.<BR>
<BR>
<TABLE>
<TR><TD>Result</TD><TD>Function</TD></TR>
<TR><TD>Test ok</TD><TD>pass</TD></TR>
<TR><TD>Test unknown</TD><TD>warning</TD></TR>
<TR><TD>Test fail</TD><TD>fail</TD></TR>
</TABLE>
<BR>
<smaller>Remember: Don't <tt>return</tt> the result, but call the function instead !</smaller><BR>
<BR>
<BR>
During execution of the <tt>.exp</tt> files from <tt>testsuite/<i>tool</i>.test</tt>
the dejagnu program records each result call and summarizes the result
at the end of all tests. This is what you have to look for !<BR>
<P>
<H2>A practical example, testing the ycp interpreter</H2>
For the ycp interpreter, each <tt>.ycp</tt> input file is accompanied
by the expected output and the expected error messages. The latter is
particulary useful in testing the error handling. One might also define
a test as 'expected failure' to declare a test as 'must fail'. See the
dejagnu documentation for more information about this.<BR>
<P>
To be continued ...
<p><hr>
<SMALL>Letzte Änderung 12-Oct-2000, 17:10, <A HREF="mailto:kkaempf@suse.de">Klaus Kämpf</A></SMALL><BR>
<SMALL>Copyright &copy; by <A HREF="http://w3.suse.de">SuSE GmbH</A></SMALL>
</BODY>
</HTML>

